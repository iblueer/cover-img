<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>封面五合一</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        :root {
            --highlight-color: #00ff41;
            --body-bg: #000;
            --body-text: #fff;
            --sidebar-bg: #111;
            --sidebar-border: #333;
            --surface-bg: #000;
            --surface-border: #333;
            --surface-divider: #333;
            --input-bg: #222;
            --input-border: #444;
            --input-text: #fff;
            --grid-line-color: rgba(255,255,255,0.03);
            --title-primary-color: #fff;
            --title-secondary-color: rgba(255,255,255,0.9);
            --title-tertiary-color: rgba(255,255,255,0.7);
            --share-text-color: #fff;
            --button-text-color: #000;
            --highlight-text-color: #000;
            --export-background: #000;
            --corner-frame-color: rgba(255,255,255,0.3);
        }

        body[data-theme="apple-light"] {
            --body-bg: #ffffff;
            --body-text: #313131;
            --sidebar-bg: #f3f4f6;
            --sidebar-border: #d1d5db;
            --surface-bg: #ffffff;
            --surface-border: #e5e7eb;
            --surface-divider: #e5e7eb;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --input-text: #1f2933;
            --grid-line-color: rgba(0,0,0,0.08);
            --title-primary-color: #1a1a1a;
            --title-secondary-color: rgba(0,0,0,0.75);
            --title-tertiary-color: rgba(0,0,0,0.6);
            --share-text-color: #111827;
            --button-text-color: #000000;
            --highlight-text-color: #000000;
            --export-background: #ffffff;
            --corner-frame-color: rgba(0,0,0,0.15);
        }

        body[data-theme="geek-dark"] {
            --body-bg: #000000;
            --body-text: #f4f4f4;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--body-bg);
            color: var(--body-text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
        }
        
        .main-layout {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }
        
        .content-area {
            flex: 1;
            padding: 20px;
            padding-right: 370px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .sidebar {
            width: 350px;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--sidebar-border);
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .cover-container {
            width: 100%;
            max-width: 900px;
            aspect-ratio: 3.35/1;
            display: flex;
            position: relative;
            background: var(--surface-bg);
            border: 1px solid var(--surface-border);
            overflow: hidden;
        }

        .main-cover {
            width: 70.15%;
            aspect-ratio: 2.35/1;
            position: relative;
            border-right: 1px solid var(--surface-divider);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            box-sizing: border-box;
        }

        .share-cover {
            width: 29.85%;
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            position: relative;
            padding: 10px;
            box-sizing: border-box;
        }

        .share-cover .text-row {
            font-size: clamp(16px, 2.5vw, 32px);
            line-height: 1.2;
            letter-spacing: 0.1em;
            font-weight: 900;
            text-align: center;
            color: var(--share-text-color);
            margin: 4px 0;
            width: 100%;
            white-space: pre-wrap;
        }

        .title-main {
            font-size: clamp(20px, 3.5vw, 40px);
            font-weight: 900;
            line-height: 1.0;
            text-align: left;
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            color: var(--title-primary-color);
        }

        .title-wrapper {
            position: relative;
            z-index: 10;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .title-illustration {
            width: 100%;
            flex: 0 0 auto;
            display: none;
            overflow: hidden;
        }

        .title-illustration img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .title-illustration.has-image {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-line {
            display: block;
            position: relative;
            margin-bottom: 8px;
            color: var(--title-primary-color);
            white-space: pre-wrap;
        }

        .title-line:nth-child(1) {
            font-size: 1.2em;
        }

        .title-line:nth-child(2) {
            font-size: 0.8em;
            /* 使用半透明颜色替代 opacity，提升 html2canvas 兼容 */
            color: var(--title-secondary-color);
        }

        .title-line:nth-child(3) {
            font-size: 0.6em;
            color: var(--title-tertiary-color);
            /* font-family: 'JetBrains Mono', monospace; */
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--grid-line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line-color) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }

        .accent-line {
            position: absolute;
            background: var(--highlight-color);
        }

        .accent-line-1 {
            width: 2px;
            height: 60px;
            top: 20px;
            left: 20px;
            transform: rotate(-45deg);
        }

        .accent-line-2 {
            width: 40px;
            height: 1px;
            bottom: 30px;
            right: 30px;
        }

        .highlight {
            background: var(--highlight-color);
            color: var(--highlight-text-color);
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .highlight-inline {
            color: var(--highlight-color);
            font-weight: inherit;
        }

        body[data-theme="apple-light"] .title-line {
            font-size: 0.8em;
            color: var(--title-primary-color);
            font-family: 'Noto Sans SC', sans-serif;
            line-height: 2;
            margin-bottom: 0;
        }

        body[data-theme="apple-light"] .title-line:nth-child(2),
        body[data-theme="apple-light"] .title-line:nth-child(3),
        body[data-theme="apple-light"] .title-line:nth-child(4) {
            color: var(--title-primary-color);
        }

        body[data-theme="apple-light"] .grid-overlay,
        body[data-theme="apple-light"] .corner-frame,
        body[data-theme="apple-light"] .accent-line,
        body[data-theme="apple-light"] .arrow-indicator {
            display: none;
        }

        body[data-theme="apple-light"] .main-cover,
        body[data-theme="apple-light"] .single-main-cover {
            justify-content: flex-start;
            align-items: stretch;
            padding: 48px 0;
        }

        body[data-theme="apple-light"] .title-wrapper {
            flex: 1 1 auto;
            margin: 0 48px;
            gap: 32px;
        }

        body[data-theme="apple-light"] .title-illustration {
            flex: 1 1 0%;
        }

        .corner-frame {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 1px solid var(--corner-frame-color);
        }

        .corner-frame-1 {
            top: 10px;
            left: 10px;
            border-right: none;
            border-bottom: none;
        }

        .corner-frame-2 {
            bottom: 10px;
            right: 10px;
            border-left: none;
            border-top: none;
        }

        .arrow-indicator {
            position: absolute;
            opacity: 0.5;
            /* 使用CSS绘制箭头，替代Font Awesome图标 */
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid var(--highlight-color);
        }

        .arrow-1 {
            top: 50%;
            right: 25%;
            transform: translateY(-50%) rotate(90deg);
        }

        .btn {
            padding: 12px 24px;
            background: var(--highlight-color);
            color: var(--button-text-color);
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--highlight-color) 30%, transparent);
        }

        .btn:disabled,
        .btn:disabled:hover {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .download-btn {
            margin-top: 20px;
        }

        .single-download-btn {
            margin-top: 12px;
            align-self: flex-end;
            padding: 8px 16px;
            font-size: 13px;
        }

        .input-panel {
            background: transparent;
            border: none;
            padding: 0;
            margin-bottom: 20px;
            width: 100%;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            color: var(--body-text);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .input-field {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 10px;
            color: var(--input-text);
            font-size: 14px;
            font-family: 'Noto Sans SC', sans-serif;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--highlight-color);
            box-shadow: 0 0 0 2px var(--highlight-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--highlight-color) 40%, transparent);
        }

        .illustration-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-input {
            width: 100%;
            background: var(--input-bg);
            border: 1px dashed var(--input-border);
            border-radius: 4px;
            padding: 8px;
            color: var(--input-text);
            font-size: 13px;
        }

        .file-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-help {
            margin-top: 4px;
            font-size: 12px;
            color: color-mix(in srgb, var(--body-text) 60%, transparent);
        }

        #themeColor {
            height: 100%;
        }

        .textarea-field {
            resize: vertical;
            min-height: 100px;
        }

        .covers-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
            max-width: 1000px;
        }

        .cover-item {
            width: 100%;
        }

        .cover-title {
            color: var(--body-text);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }

        .ratio-3-35-1 {
            aspect-ratio: 3.35/1;
            display: flex;
            flex-direction: row;
        }

        .ratio-16-9 {
            aspect-ratio: 16/9;
            display: flex;
            flex-direction: row;
        }

        .ratio-9-16 {
            aspect-ratio: 9/16;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            margin: 0 auto;
        }

        .ratio-3-4 {
            aspect-ratio: 3/4;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
        }

        .ratio-4-3 {
            aspect-ratio: 4/3;
            display: flex;
            flex-direction: row;
        }

        .single-main-cover {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

                @media (max-width: 1200px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-left: none;
                border-bottom: 1px solid #333;
                order: -1;
            }
            
            .content-area {
                padding-right: 20px;
            }
            
            .main-layout {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .content-area {
                padding: 10px;
            }
            
            .main-cover {
                padding: 10px;
            }
            
            .title-main {
                font-size: clamp(16px, 3vw, 32px);
            }
            
            .share-cover .text-row {
                font-size: clamp(14px, 2vw, 24px);
            }
        }
    </style>
</head>
<body data-theme="geek-dark">
    <div class="main-layout">
        <!-- 主内容区域 -->
        <div class="content-area">
            <!-- 封面预览区域 -->
        <div class="covers-grid">
            <!-- 3.35:1 公众号封面 -->
            <div class="cover-item">
                <h3 class="cover-title">3.35:1 (公众号封面)</h3>
                <div class="cover-container ratio-3-35-1" data-ratio="3.35:1">
                    <div class="main-cover">
                        <div class="grid-overlay"></div>
                        <div class="corner-frame corner-frame-1"></div>
                        <div class="corner-frame corner-frame-2"></div>
                        <div class="accent-line accent-line-1"></div>
                        <div class="accent-line accent-line-2"></div>
                        <div class="title-wrapper">
                            <div class="title-main" data-target="main-title">
                                <span class="title-line">超级超强超绝坚固的铝金属。</span>
                                <span class="title-line"> 有 Mac 都好办。</span>
                            </div>
                            <div class="title-illustration" data-target="cover-image" aria-hidden="true">
                                <img alt="封面插图" loading="lazy">
                            </div>
                        </div>
                        <div class="arrow-indicator arrow-1"></div>
                    </div>
                    <div class="share-cover" data-target="share-text">
                        <div class="grid-overlay"></div>
                        <div class="text-row">分享封面</div>
                        <div class="text-row">两行四字</div>
                    </div>
                </div>
                <button type="button" class="btn single-download-btn" onclick="downloadSingle(this)">下载</button>
            </div>

            <!-- 16:9 横屏封面 -->
            <div class="cover-item">
                <h3 class="cover-title">16:9 (横屏)</h3>
                <div class="cover-container ratio-16-9" data-ratio="16:9">
                    <div class="single-main-cover">
                        <div class="grid-overlay"></div>
                        <div class="corner-frame corner-frame-1"></div>
                        <div class="corner-frame corner-frame-2"></div>
                        <div class="accent-line accent-line-1"></div>
                        <div class="accent-line accent-line-2"></div>
                        <div class="title-wrapper">
                            <div class="title-main" data-target="main-title">
                                <span class="title-line">超级超强超绝坚固的铝金属。</span>
                                <span class="title-line"> 有 Mac 都好办。</span>
                            </div>
                            <div class="title-illustration" data-target="cover-image" aria-hidden="true">
                                <img alt="封面插图" loading="lazy">
                            </div>
                        </div>
                        <div class="arrow-indicator arrow-1"></div>
                    </div>
                </div>
                <button type="button" class="btn single-download-btn" onclick="downloadSingle(this)">下载</button>
            </div>

            <!-- 9:16 竖屏封面 -->
            <div class="cover-item">
                <h3 class="cover-title">9:16 (竖屏)</h3>
                <div class="cover-container ratio-9-16" data-ratio="9:16">
                    <div class="single-main-cover">
                        <div class="grid-overlay"></div>
                        <div class="corner-frame corner-frame-1"></div>
                        <div class="corner-frame corner-frame-2"></div>
                        <div class="accent-line accent-line-1"></div>
                        <div class="accent-line accent-line-2"></div>
                        <div class="title-wrapper">
                            <div class="title-main" data-target="main-title">
                                <span class="title-line">超级超强超绝坚固的铝金属。</span>
                                <span class="title-line"> 有 Mac 都好办。</span>
                            </div>
                            <div class="title-illustration" data-target="cover-image" aria-hidden="true">
                                <img alt="封面插图" loading="lazy">
                            </div>
                        </div>
                        <div class="arrow-indicator arrow-1"></div>
                    </div>
                </div>
                <button type="button" class="btn single-download-btn" onclick="downloadSingle(this)">下载</button>
            </div>

            <!-- 3:4 竖屏封面 -->
            <div class="cover-item">
                <h3 class="cover-title">3:4 (竖屏)</h3>
                <div class="cover-container ratio-3-4" data-ratio="3:4">
                    <div class="single-main-cover">
                        <div class="grid-overlay"></div>
                        <div class="corner-frame corner-frame-1"></div>
                        <div class="corner-frame corner-frame-2"></div>
                        <div class="accent-line accent-line-1"></div>
                        <div class="accent-line accent-line-2"></div>
                        <div class="title-wrapper">
                            <div class="title-main" data-target="main-title">
                                <span class="title-line">超级超强超绝坚固的铝金属。</span>
                                <span class="title-line"> 有 Mac 都好办。</span>
                            </div>
                            <div class="title-illustration" data-target="cover-image" aria-hidden="true">
                                <img alt="封面插图" loading="lazy">
                            </div>
                        </div>
                        <div class="arrow-indicator arrow-1"></div>
                    </div>
                </div>
                <button type="button" class="btn single-download-btn" onclick="downloadSingle(this)">下载</button>
            </div>

            <!-- 4:3 横屏封面 -->
            <div class="cover-item">
                <h3 class="cover-title">4:3 (横屏)</h3>
                <div class="cover-container ratio-4-3" data-ratio="4:3">
                    <div class="single-main-cover">
                        <div class="grid-overlay"></div>
                        <div class="corner-frame corner-frame-1"></div>
                        <div class="corner-frame corner-frame-2"></div>
                        <div class="accent-line accent-line-1"></div>
                        <div class="accent-line accent-line-2"></div>
                        <div class="title-wrapper">
                            <div class="title-main" data-target="main-title">
                                <span class="title-line">超级超强超绝坚固的铝金属。</span>
                                <span class="title-line"> 有 Mac 都好办。</span>
                            </div>
                            <div class="title-illustration" data-target="cover-image" aria-hidden="true">
                                <img alt="封面插图" loading="lazy">
                            </div>
                        </div>
                        <div class="arrow-indicator arrow-1"></div>
                    </div>
                </div>
                <button type="button" class="btn single-download-btn" onclick="downloadSingle(this)">下载</button>
            </div>
            </div>
        </div>
        
        <!-- 右侧边栏 -->
        <div class="sidebar">
            <!-- 输入面板 -->
            <div class="input-panel">
                <div class="input-group">
                    <label class="input-label">主封面标题（每行一个）</label>
                    <textarea class="input-field textarea-field" id="mainTitle" placeholder="请输入主封面标题，每行一个内容，最多4行">超级超强超绝**坚固的铝金属。**
 有 Mac **都好办。**</textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">分享封面文字（两行，空格分隔，4字以内）</label>
                    <input type="text" class="input-field" id="shareText" placeholder="请输入分享封面文字，用空格分隔两行，如：分享封面 两行四字" value="分享封面 两行四字" maxlength="10">
                </div>

                <div class="input-group">
                    <label class="input-label">主题</label>
                    <select id="themeSelect" class="input-field">
                        <option value="geek-dark">极客暗色</option>
                        <option value="apple-light">苹果亮色</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">高亮色</label>
                    <div style="display:flex; align-items:center; gap:10px; height: 40px;">
                        <select id="themeColorSelect" class="input-field" style="max-width: 160px;">
                            <!-- 选项在脚本中按调色板填充 -->
                        </select>
                        <input type="color" id="themeColor" class="input-field" value="#00ff41" style="padding:0; width:60px;">
                        <button type="button" id="randomColorBtn" class="btn" style="padding:8px 14px;">随机</button>
                    </div>
                </div>

                <div class="input-group" id="illustrationControls">
                    <label class="input-label">插图（仅苹果亮色）</label>
                    <div class="illustration-control">
                        <input type="file" id="illustrationInput" class="file-input" accept="image/*">
                        <button type="button" id="clearIllustrationBtn" class="btn" style="padding:8px 14px;">清除</button>
                    </div>
                    <p class="input-help">支持 PNG、JPG、SVG，自动缩放以完整显示。</p>
                </div>
            </div>
            
            <button class="btn download-btn" style="height: 60px;" onclick="downloadImage()">
                <i class="fas fa-download mr-2"></i>下载所有尺寸
            </button>
            <p class="text-sm text-gray-400 mt-4 text-right">Inspired by @归藏</p>
            <p class="text-sm text-gray-400 mt-4 text-right">Created By @张佳 & Cursor</p>
            <p class="text-sm text-gray-400 mt-4 text-right">Modified By @Maemo_Lee & CodeX</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // 配置对象
        const DEFAULT_HIGHLIGHT = '#00ff41';

        const colorConfig = {
            colors: [
                '#00ff41', '#ff0080', '#00bfff', '#ff6b35',
                '#9d4edd', '#06ffa5', '#ffbe0b', '#fb5607'
            ]
        };

        const colorLabels = {
            '#00ff41': '霓虹绿',
            '#ff0080': '玫红',
            '#00bfff': '天空蓝',
            '#ff6b35': '活力橙',
            '#9d4edd': '暗紫',
            '#06ffa5': '薄荷绿',
            '#ffbe0b': '琥珀黄',
            '#fb5607': '橘红'
        };

        const themes = {
            'geek-dark': {
                key: 'geek-dark',
                label: '极客暗色',
                maxTitleLines: 4,
                allowIllustration: false
            },
            'apple-light': {
                key: 'apple-light',
                label: '苹果亮色',
                maxTitleLines: 2,
                allowIllustration: true
            }
        };

        const storageKeys = {
            highlight: 'themeColor',
            theme: 'themeStyle',
            illustration: 'appleLightIllustration'
        };

        const resolveThemeKey = (theme) => {
            const key = (theme || '').toLowerCase();
            return themes[key] ? key : 'geek-dark';
        };

        const getStoredValue = (key) => {
            try {
                return localStorage.getItem(key);
            } catch (_) {
                return null;
            }
        };

        const setStoredValue = (key, value) => {
            try {
                if (value) {
                    localStorage.setItem(key, value);
                } else {
                    localStorage.removeItem(key);
                }
            } catch (_) {}
        };

        const initialThemeKey = resolveThemeKey(getStoredValue(storageKeys.theme));

        const state = {
            selectedColor: (getStoredValue(storageKeys.highlight) || DEFAULT_HIGHLIGHT).toLowerCase(),
            selectedTheme: initialThemeKey,
            illustrationData: getStoredValue(storageKeys.illustration) || ''
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            initThemeControls();
            applyTheme(state.selectedTheme);
            setHighlightColor(state.selectedColor);
            setupEventListeners();
            updateIllustrationControls();
            updateAllDisplays();
            // 预热字体，提升首次导出稳定性
            await waitForFonts();
        });

        // 预加载并等待字体加载完成，避免导出时文字缺失
        async function waitForFonts() {
            try {
                const fontPromises = [];
                // 针对页面使用到的字体和可能的字号/字重进行加载提示
                fontPromises.push(document.fonts.load("400 14px Noto Sans SC"));
                fontPromises.push(document.fonts.load("700 16px Noto Sans SC"));
                fontPromises.push(document.fonts.load("900 32px Noto Sans SC"));
                fontPromises.push(document.fonts.load("400 14px JetBrains Mono"));
                fontPromises.push(document.fonts.load("700 18px JetBrains Mono"));
                // Font Awesome 图标字体（fas 通常为 900 粗细）
                fontPromises.push(document.fonts.load("900 20px 'Font Awesome 6 Free'"));
                // 等待所有显式加载和 document.fonts.ready
                await Promise.allSettled(fontPromises);
                await document.fonts.ready;
                // 最后一帧确保布局稳定
                await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
            } catch (e) {
                // 即使出错也不阻断导出，但会在控制台记录
                console.warn('等待字体时发生问题:', e);
            }
        }

        function setupEventListeners() {
            const mainTitleInput = document.getElementById('mainTitle');
            const shareTextInput = document.getElementById('shareText');
            if (mainTitleInput) mainTitleInput.addEventListener('input', updateAllDisplays);
            if (shareTextInput) shareTextInput.addEventListener('input', updateAllDisplays);

            const themeSelectControl = document.getElementById('themeSelect');
            if (themeSelectControl) {
                themeSelectControl.addEventListener('change', (e) => {
                    const val = String(e.target.value || '').toLowerCase();
                    applyTheme(val);
                    updateAllDisplays();
                });
            }

            const colorInput = document.getElementById('themeColor');
            const paletteSelect = document.getElementById('themeColorSelect');
            const randomBtn = document.getElementById('randomColorBtn');

            if (colorInput) {
                colorInput.addEventListener('input', (e) => {
                    const val = String(e.target.value || '').toLowerCase();
                    setHighlightColor(val);
                    if (paletteSelect) {
                        const palette = colorConfig.colors.map(c => c.toLowerCase());
                        paletteSelect.value = palette.includes(val) ? val : 'custom';
                    }
                });
            }

            if (paletteSelect) {
                paletteSelect.addEventListener('change', (e) => {
                    const val = String(e.target.value || '').toLowerCase();
                    if (val === 'custom') {
                        if (colorInput && !colorInput.value) colorInput.value = state.selectedColor;
                    } else {
                        setHighlightColor(val);
                        if (colorInput) colorInput.value = val;
                    }
                });
            }

            if (randomBtn) {
                randomBtn.addEventListener('click', () => {
                    const palette = colorConfig.colors.map(c => c.toLowerCase());
                    const next = palette[Math.floor(Math.random() * palette.length)];
                    if (paletteSelect) paletteSelect.value = next;
                    if (colorInput) colorInput.value = next;
                    setHighlightColor(next);
                });
            }

            const illustrationInput = document.getElementById('illustrationInput');
            const clearIllustrationBtn = document.getElementById('clearIllustrationBtn');

            if (illustrationInput) {
                illustrationInput.addEventListener('change', handleIllustrationChange);
            }

            if (clearIllustrationBtn) {
                clearIllustrationBtn.addEventListener('click', clearIllustration);
            }
        }

        function stripBoldSyntax(text) {
            const source = typeof text === 'string' ? text : String(text || '');
            const withoutBlock = source.replace(/\*\*(.*?)\*\*/g, '$1');
            return withoutBlock.replace(/\*(.*?)\*/g, '$1');
        }

        function renderTextWithMarkdown(container, text, options = {}) {
            const source = typeof text === 'string' ? text : String(text || '');
            const fragment = document.createDocumentFragment();
            const maxChars = typeof options.maxChars === 'number' ? options.maxChars : null;
            let consumed = 0;
            let done = false;

            const appendSegment = (segment, type) => {
                if (!segment || done) return;
                let textSegment = segment;
                if (maxChars !== null) {
                    const remaining = maxChars - consumed;
                    if (remaining <= 0) {
                        done = true;
                        return;
                    }
                    textSegment = segment.slice(0, remaining);
                }

                if (!textSegment) {
                    return;
                }

                if (type === 'highlight-bg') {
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    span.textContent = textSegment;
                    fragment.appendChild(span);
                } else if (type === 'highlight-text') {
                    const span = document.createElement('span');
                    span.className = 'highlight-inline';
                    span.textContent = textSegment;
                    fragment.appendChild(span);
                } else {
                    fragment.appendChild(document.createTextNode(textSegment));
                }

                consumed += textSegment.length;
                if (maxChars !== null && consumed >= maxChars) {
                    done = true;
                }
            };

            const flushBuffer = (buffer) => {
                if (buffer) {
                    appendSegment(buffer, 'text');
                }
                return '';
            };

            let buffer = '';
            let i = 0;
            while (i < source.length && !done) {
                if (source.startsWith('**', i)) {
                    const end = source.indexOf('**', i + 2);
                    if (end !== -1) {
                        buffer = flushBuffer(buffer);
                        const content = source.slice(i + 2, end);
                        appendSegment(content, 'highlight-bg');
                        i = end + 2;
                        continue;
                    }
                }
                if (source[i] === '*') {
                    const end = source.indexOf('*', i + 1);
                    if (end !== -1) {
                        buffer = flushBuffer(buffer);
                        const content = source.slice(i + 1, end);
                        appendSegment(content, 'highlight-text');
                        i = end + 1;
                        continue;
                    }
                }

                buffer += source[i];
                i += 1;
            }

            if (!done) {
                flushBuffer(buffer);
            }

            container.appendChild(fragment);
        }

        function getThemeConfig(theme) {
            const key = resolveThemeKey(theme);
            return themes[key];
        }

        function applyTheme(theme) {
            const config = getThemeConfig(theme);
            state.selectedTheme = config.key;
            document.body.dataset.theme = state.selectedTheme;
            setStoredValue(storageKeys.theme, state.selectedTheme);
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect && themeSelect.value !== state.selectedTheme) {
                themeSelect.value = state.selectedTheme;
            }
            updateIllustrationControls();
            updateIllustrations();
        }

        function updateIllustrationControls() {
            const controls = document.getElementById('illustrationControls');
            const fileInput = document.getElementById('illustrationInput');
            const clearButton = document.getElementById('clearIllustrationBtn');
            const { allowIllustration } = getThemeConfig(state.selectedTheme);

            if (controls) {
                controls.style.display = allowIllustration ? 'block' : 'none';
            }
            if (fileInput) {
                fileInput.disabled = !allowIllustration;
                if (!allowIllustration) {
                    fileInput.value = '';
                }
            }
            if (clearButton) {
                const disabled = !allowIllustration || !state.illustrationData;
                clearButton.disabled = disabled;
                clearButton.style.opacity = disabled ? '0.6' : '';
            }
        }

        function updateIllustrations() {
            const { allowIllustration } = getThemeConfig(state.selectedTheme);
            document.querySelectorAll('[data-target="cover-image"]').forEach(container => {
                const img = container.querySelector('img');
                if (!img) return;
                if (allowIllustration && state.illustrationData) {
                    img.src = state.illustrationData;
                    container.classList.add('has-image');
                    container.setAttribute('aria-hidden', 'false');
                } else {
                    img.removeAttribute('src');
                    container.classList.remove('has-image');
                    container.setAttribute('aria-hidden', 'true');
                }
            });
        }

        function handleIllustrationChange(event) {
            const file = event?.target?.files?.[0];
            if (!file) {
                return;
            }
            if (!file.type.startsWith('image/')) {
                console.warn('请选择图片文件');
                return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                state.illustrationData = reader.result || '';
                setStoredValue(storageKeys.illustration, state.illustrationData);
                updateIllustrations();
                updateIllustrationControls();
            };
            reader.readAsDataURL(file);
        }

        function clearIllustration() {
            state.illustrationData = '';
            setStoredValue(storageKeys.illustration, '');
            const fileInput = document.getElementById('illustrationInput');
            if (fileInput) {
                fileInput.value = '';
            }
            updateIllustrations();
            updateIllustrationControls();
        }

        function getExportBackground() {
            const value = getComputedStyle(document.body).getPropertyValue('--export-background').trim();
            return value || '#000000';
        }

        function initThemeControls() {
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.innerHTML = '';
                Object.values(themes).forEach(({ key, label }) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = label;
                    themeSelect.appendChild(opt);
                });
                themeSelect.value = state.selectedTheme;
            }

            const select = document.getElementById('themeColorSelect');
            const colorInput = document.getElementById('themeColor');
            if (select) {
                select.innerHTML = '';
                colorConfig.colors.forEach((hex) => {
                    const opt = document.createElement('option');
                    const value = hex.toLowerCase();
                    const label = colorLabels[value] || value;
                    opt.value = value;
                    opt.textContent = `${label} ${value}`;
                    select.appendChild(opt);
                });
                const customOpt = document.createElement('option');
                customOpt.value = 'custom';
                customOpt.textContent = '自定义…';
                select.appendChild(customOpt);

                const palette = colorConfig.colors.map(c => c.toLowerCase());
                select.value = palette.includes(state.selectedColor) ? state.selectedColor : 'custom';
            }

            if (colorInput) {
                colorInput.value = state.selectedColor;
            }
        }

        function updateAllDisplays() {
            updateMainTitles();
            updateShareTexts();
            applyDynamicStyling();
            updateIllustrations();
        }

        function updateMainTitles() {
            const titleText = document.getElementById('mainTitle').value;
            const themeConfig = getThemeConfig(state.selectedTheme);
            const maxLines = (themeConfig && Number.isFinite(themeConfig.maxTitleLines)) ? themeConfig.maxTitleLines : 4;
            const lines = titleText.split('\n').slice(0, maxLines);
            
            // 更新所有主标题显示
            document.querySelectorAll('[data-target="main-title"]').forEach(titleDisplay => {
                titleDisplay.innerHTML = '';
                lines.forEach((line) => {
                    const span = document.createElement('span');
                    span.className = 'title-line';
                    const content = line.replace(/\r/g, '');
                    if (content.length === 0) {
                        span.innerHTML = '&nbsp;';
                    } else {
                        renderTextWithMarkdown(span, content);
                    }
                    titleDisplay.appendChild(span);
                });
            });
        }

        function updateShareTexts() {
            const shareText = document.getElementById('shareText').value;
            const lines = shareText.split(' ').filter(line => line.trim()).slice(0, 2);
            
            // 确保有两行，如果只有一行则添加空行
            while (lines.length < 2) {
                lines.push('');
            }

            // 更新所有分享文字显示
            document.querySelectorAll('[data-target="share-text"]').forEach(shareDisplay => {
                const gridOverlay = shareDisplay.querySelector('.grid-overlay');
                
                // 清空现有内容但保留grid-overlay
                shareDisplay.innerHTML = '';
                shareDisplay.appendChild(gridOverlay);
                
                lines.forEach(line => {
                    const div = document.createElement('div');
                    div.className = 'text-row';
                    renderTextWithMarkdown(div, line.trim(), { maxChars: 4 });
                    shareDisplay.appendChild(div);
                });
            });
        }

        function applyDynamicStyling() {
            const titleText = document.getElementById('mainTitle').value;
            // 仅动态调整字体大小，不改主题色，避免输入时颜色变化
            const themeConfig = getThemeConfig(state.selectedTheme);
            const themeKey = themeConfig?.key || resolveThemeKey(state.selectedTheme);
            const maxLines = (themeConfig && Number.isFinite(themeConfig.maxTitleLines)) ? themeConfig.maxTitleLines : 4;
            const titleLines = titleText.split('\n').slice(0, maxLines).filter(line => line.trim());

            if (themeKey === 'apple-light') {
                document.querySelectorAll('.title-main').forEach(titleMain => {
                    titleMain.style.fontSize = '';
                });
                return;
            }

            const sanitized = titleLines.map(stripBoldSyntax);
            const maxLineLength = sanitized.length ? Math.max(...sanitized.map(line => line.length)) : 0;
            
            let fontSize = 'clamp(20px, 3.5vw, 40px)';
            if (maxLineLength > 20) {
                fontSize = 'clamp(16px, 3vw, 32px)';
            } else if (maxLineLength > 15) {
                fontSize = 'clamp(18px, 3.2vw, 36px)';
            }
            
            // 应用到所有标题
            document.querySelectorAll('.title-main').forEach(titleMain => {
                titleMain.style.fontSize = fontSize;
            });
        }

        // 更新主题色（仅在用户选择或点击随机时调用）
        function setHighlightColor(color) {
            const normalized = String(color || '').toLowerCase();
            const value = normalized || DEFAULT_HIGHLIGHT;
            state.selectedColor = value;
            document.documentElement.style.setProperty('--highlight-color', value);
            setStoredValue(storageKeys.highlight, value);
        }

        async function downloadImage() {
            const zip = new JSZip();
            const containers = document.querySelectorAll('.cover-container');
            const exportBg = getExportBackground();

            // 确保字体与布局就绪，避免文字丢失
            await waitForFonts();

            for (let i = 0; i < containers.length; i++) {
                const container = containers[i];
                const ratio = container.dataset.ratio;

                try {
                    // 再次确保本容器内的字体已渲染
                    await waitForFonts();

                    // 使用html-to-image替代html2canvas
                    const blob = await htmlToImage.toBlob(container, {
                        backgroundColor: exportBg,
                        pixelRatio: 2,
                        cacheBust: true,
                        style: {
                            margin: '0',
                            padding: '0'
                        }
                    });

                    zip.file(`封面_${ratio.replace(':', '-')}.png`, blob);
                } catch (error) {
                    console.error(`生成 ${ratio} 尺寸时出错:`, error);
                }

                // 短暂延迟以确保渲染完成
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // 生成并下载zip文件
            try {
                const content = await zip.generateAsync({type: 'blob'});
                const link = document.createElement('a');
                link.download = `封面合集_${new Date().getTime()}.zip`;
                link.href = URL.createObjectURL(content);
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('生成ZIP文件时出错:', error);
            }
        }

        async function downloadSingle(button) {
            const coverItem = button.closest('.cover-item');
            if (!coverItem) return;
            const container = coverItem.querySelector('.cover-container');
            if (!container) return;

            const ratio = container.dataset.ratio || 'single';
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '处理中…';

            try {
                await waitForFonts();
                const exportBg = getExportBackground();

                // 使用html-to-image替代html2canvas
                const blob = await htmlToImage.toBlob(container, {
                    backgroundColor: exportBg,
                    pixelRatio: 2,
                    cacheBust: true,
                    style: {
                        margin: '0',
                        padding: '0'
                    }
                });

                if (!blob) throw new Error('生成 PNG 失败');

                const link = document.createElement('a');
                link.download = `封面_${ratio.replace(':', '-')}.png`;
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('导出单个封面失败:', error);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
    </script>
</body>
</html>
